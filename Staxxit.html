<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staxxit - Interactive Board Game Simulator</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; text-align: center; padding: 20px; }
        canvas { border: 2px solid #333; background: #fff; cursor: pointer; }
        button { margin: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #info { margin: 20px; font-size: 18px; }
        #multiplayer { margin: 20px; }
        input { padding: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>üï∏Ô∏è Staxxit</h1>
    <p>Interactive game. Play hotseat, vs AI, or online multiplayer. White starts. Click to place/move/capture. Must capture if possible!</p>
    <canvas id="game" width="1400" height="900"></canvas>
    <br>
    <div id="localControls">
        <button onclick="quickSetup()">Quick Random Setup (Hotseat)</button>
        <button onclick="quickSetup('B')">Quick Setup (vs AI as Blue)</button>
        <button onclick="quickSetup('W')">Quick Setup (vs AI as White)</button>
        <button onclick="newGame()">New Game (Hotseat)</button>
        <button onclick="newGame('B')">New Game (vs AI as Blue)</button>
        <button onclick="newGame('W')">New Game (vs AI as White)</button>
    </div>
    <div id="multiplayer">
        <button onclick="createOnlineGame()">Create Online Game</button>
        <input id="joinCode" placeholder="Enter join code" />
        <button onclick="joinOnlineGame()">Join Online Game</button>
        <div id="roomInfo"></div>
    </div>
    <button onclick="toggleDebug()">Toggle Coord Labels</button>
    <button id="toggleSuggestionsBtn" onclick="toggleSuggestions()">Suggestions on</button>
    <button id="aiLevelBtn" onclick="toggleAILevel()">AI level: easy</button>
    <button id="undoBtn" onclick="undoMove()" disabled>Undo</button>
    <button id="replayBtn" onclick="replayLastAIMove()" disabled>Show last AI move again</button>
    <button id="replayOpponentBtn" onclick="replayLastOpponentMove()" disabled>Replay opponent's move</button>
    <div id="info"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const size = 36;
        let debug = false;
        let showSuggestions = true;
        let aiDifficulty = 'easy';

        const dirs = [
            [1, 0], [1, -1], [0, -1],
            [-1, 0], [-1, 1], [0, 1]
        ];

        let innerHexes = [];
        let outerHexes = [];
        let outerColors = {};
        let dualKeys = new Set(['6,0', '0,6', '-6,6', '0,-6', '6,-6', '-6,0']);
        let board = {};
        let phase = 'place';
        let currentPlayer = 'W';
        let piecesLeft = { W: 18, B: 18 };
        let occupied = new Set();
        let selected = null;
        let possibleTargets = [];
        let history = [];
        let aiPlayer = null;
        let flashingFrom = null;
        let flashingTo = null;
        let lastAIAction = null;
        let aiPrevState = null;
        let canReplayAI = false;

        let isOnline = false;
        let myColor = null;
        let roomId = null;

        // New for opponent replay
        let lastOpponentAction = null;
        let opponentPrevState = null;
        let canReplayOpponent = false;

        function precomputeHexes() {
            // ... (unchanged, omit for brevity)
        }

        // ... (other functions like getAngle, cubeDist, etc., unchanged)

        function onHexClick(key) {
            // ... (unchanged)
        }

        // ... (other functions like triggerAIMove, aiMove, checkEnd, draw functions, newGame, quickSetup, toggles, undoMove, replayLastAIMove unchanged)

        // New: Replay opponent's last move
        function replayLastOpponentMove() {
            if (!canReplayOpponent || lastOpponentAction === null || opponentPrevState === null) return;

            restoreState(opponentPrevState);
            draw();

            setTimeout(() => {
                flashingFrom = lastOpponentAction.type === 'place' ? lastOpponentAction.pos : lastOpponentAction.from;
                draw();
                setTimeout(() => {
                    flashingFrom = null;
                    const player = opponentPrevState.currentPlayer;
                    if (lastOpponentAction.type === 'place') {
                        const pos = lastOpponentAction.pos;
                        board[pos] = { stack: [player] };
                        occupied.add(pos);
                        piecesLeft[player]--;
                        if (piecesLeft.W + piecesLeft.B === 0) {
                            phase = 'play';
                        }
                    } else {
                        const from = lastOpponentAction.from;
                        const to = lastOpponentAction.to;
                        const stFrom = getState(from);
                        if (lastOpponentAction.type === 'capture') {
                            const stTo = getState(to);
                            board[to].stack = stTo.stack.concat(stFrom.stack);
                        } else if (lastOpponentAction.type === 'split') {
                            board[to] = { stack: stFrom.stack.splice(lastOpponentAction.splitH1) };
                            occupied.add(to);
                        } else {
                            board[to] = { stack: stFrom.stack };
                        }
                        delete board[from];
                    }
                    flashingTo = lastOpponentAction.type === 'place' ? lastOpponentAction.pos : lastOpponentAction.to;
                    draw();
                    setTimeout(() => {
                        flashingTo = null;
                        draw();
                    }, 400);
                }, 400);
            }, 400);
        }

        // Online functions (updated to handle lastAction)
        function createOnlineGame() {
            // ... (unchanged)
        }

        function joinOnlineGame() {
            // ... (unchanged)
        }

        socket.on('gameUpdate', (gameState) => {
            const prevState = saveState();  // Save for potential replay
            board = gameState.board;
            phase = gameState.phase;
            currentPlayer = gameState.currentPlayer;
            piecesLeft = gameState.piecesLeft;
            occupied = new Set(gameState.occupied);
            outerColors = gameState.outerColors;
            selected = null;
            possibleTargets = [];
            if (isOnline && gameState.lastAction && gameState.lastAction.player !== myColor) {
                // Opponent just moved: Enable replay
                lastOpponentAction = gameState.lastAction;
                opponentPrevState = prevState;  // State before update
                canReplayOpponent = true;
            } else {
                canReplayOpponent = false;
            }
            draw();
            document.getElementById('replayOpponentBtn').disabled = !canReplayOpponent;
        });

        // ... (other socket handlers unchanged)

        // Init
        precomputeHexes();
        newGame();
        draw();
    </script>
</body>
</html>